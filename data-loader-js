// data-loader.js
const fs = require('fs');
const path = require('path');
const csv = require('csv-parser');
const https = require('https');
const fetch = require('node-fetch'); // Для использования fetch в Node.js

/**
 * Загружает файл с GitHub Raw URL
 * @param {string} githubUrl - GitHub Raw URL
 * @returns {Promise<string>} - Содержимое файла
 */
async function loadFromGitHub(githubUrl) {
  try {
    console.log(`Загрузка данных из GitHub: ${githubUrl}`);
    
    // Преобразуем GitHub URL в raw URL если нужно
    let rawUrl = githubUrl;
    if (githubUrl.includes('github.com') && !githubUrl.includes('raw.githubusercontent.com')) {
      rawUrl = githubUrl
        .replace('github.com', 'raw.githubusercontent.com')
        .replace('/blob/', '/');
    }
    
    const response = await fetch(rawUrl);
    
    if (!response.ok) {
      throw new Error(`Ошибка загрузки: ${response.status} ${response.statusText}`);
    }
    
    return await response.text();
  } catch (error) {
    throw new Error(`Ошибка загрузки с GitHub: ${error.message}`);
  }
}

/**
 * Загружает данные из локального файла
 * @param {string} filePath - Путь к файлу
 * @returns {Promise<string>} - Содержимое файла
 */
function loadFromLocal(filePath) {
  return new Promise((resolve, reject) => {
    fs.readFile(filePath, 'utf8', (err, data) => {
      if (err) reject(err);
      else resolve(data);
    });
  });
}

/**
 * Парсит CSV данные
 * @param {string} csvData - CSV данные в виде строки
 * @param {Object} options - Опции парсинга
 * @returns {Promise<Array>} - Массив объектов с данными
 */
async function parseCSVData(csvData, options = {}) {
  return new Promise((resolve, reject) => {
    const results = [];
    let dateCounter = 0;
    const startDate = new Date('2000-01-01');
    
    // Создаем поток из строки
    const { Readable } = require('stream');
    const stream = Readable.from(csvData);
    
    stream
      .pipe(csv({
        headers: false,
        skipLines: 0
      }))
      .on('data', (data) => {
        const value = data['0'];
        
        // Пропускаем строки с заголовком и пустые строки
        if (value === '^GSPC' || value === '""' || !value || value.trim() === '') {
          return;
        }
        
        try {
          const price = parseFloat(value);
          
          if (!isNaN(price)) {
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + dateCounter);
            dateCounter++;
            
            results.push({
              date: currentDate.toISOString().split('T')[0],
              price: price,
              timestamp: currentDate.getTime()
            });
          }
        } catch (error) {
          console.warn(`Ошибка обработки строки: ${value}`, error);
        }
      })
      .on('end', () => {
        console.log(`Парсинг завершен. Загружено ${results.length} записей`);
        resolve(results);
      })
      .on('error', (error) => {
        reject(error);
      });
  });
}

/**
 * Фильтрует данные, оставляя только один показатель за день
 */
function filterDailyData(data) {
  const dailyMap = new Map();
  
  data.forEach(item => {
    dailyMap.set(item.date, item);
  });
  
  return Array.from(dailyMap.values()).sort((a, b) => a.timestamp - b.timestamp);
}

/**
 * Создает сгруппированные данные по месяцам
 */
function createMonthlyData(data) {
  const monthlyMap = new Map();
  
  data.forEach(item => {
    const date = new Date(item.date);
    const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    
    if (!monthlyMap.has(yearMonth)) {
      monthlyMap.set(yearMonth, {
        date: `${yearMonth}-01`,
        open: item.price,
        high: item.price,
        low: item.price,
        close: item.price,
        volume: 0,
        count: 1
      });
    } else {
      const monthData = monthlyMap.get(yearMonth);
      monthData.high = Math.max(monthData.high, item.price);
      monthData.low = Math.min(monthData.low, item.price);
      monthData.close = item.price;
      monthData.count++;
    }
  });
  
  return Array.from(monthlyMap.values()).sort((a, b) => a.date.localeCompare(b.date));
}

/**
 * Основная функция загрузки данных
 * @param {string} source - Путь к файлу или GitHub URL
 * @param {Object} options - Опции загрузки
 * @param {boolean} options.monthly - Группировать по месяцам
 * @returns {Promise<Array>}
 */
async function loadData(source, options = { monthly: false }) {
  try {
    let csvData;
    
    // Определяем источник данных
    if (source.startsWith('http') && source.includes('github')) {
      // Загрузка с GitHub
      csvData = await loadFromGitHub(source);
    } else {
      // Загрузка локального файла
      const fullPath = path.isAbsolute(source) 
        ? source 
        : path.join(process.cwd(), source);
      
      console.log(`Загрузка локального файла: ${fullPath}`);
      
      if (!fs.existsSync(fullPath)) {
        throw new Error(`Файл не найден: ${fullPath}`);
      }
      
      csvData = await loadFromLocal(fullPath);
    }
    
    // Парсим CSV данные
    const rawData = await parseCSVData(csvData);
    
    if (rawData.length === 0) {
      throw new Error('Файл не содержит данных или имеет неправильный формат');
    }
    
    console.log(`Первые 5 записей:`, rawData.slice(0, 5));
    console.log(`Последние 5 записей:`, rawData.slice(-5));
    
    // Фильтруем для получения ежедневных данных
    const dailyData = filterDailyData(rawData);
    
    if (options.monthly) {
      const monthlyData = createMonthlyData(dailyData);
      console.log(`Создано ${monthlyData.length} месячных записей`);
      return monthlyData;
    }
    
    console.log(`Получено ${dailyData.length} уникальных дневных записей`);
    return dailyData;
    
  } catch (error) {
    console.error('Ошибка загрузки данных:', error.message);
    throw error;
  }
}

/**
 * Сохраняет данные в JSON файл
 */
function saveDataToJson(data, outputPath) {
  const fullOutputPath = path.isAbsolute(outputPath)
    ? outputPath
    : path.join(process.cwd(), outputPath);
  
  const dir = path.dirname(fullOutputPath);
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
  
  fs.writeFileSync(fullOutputPath, JSON.stringify(data, null, 2), 'utf8');
  console.log(`Данные сохранены в: ${fullOutputPath}`);
}

/**
 * Пример работы с конкретным GitHub URL
 */
async function loadFromSpecificGitHub() {
  const githubUrl = 'https://github.com/buschevapoly-del/new_project_nndl/blob/97648cb37fafc348b073c1085c7c31df779e97dd/my_data.csv';
  
  try {
    console.log('Загрузка данных с конкретного GitHub репозитория...');
    const data = await loadData(githubUrl);
    console.log(`Успешно загружено ${data.length} записей`);
    return data;
  } catch (error) {
    console.error('Ошибка:', error.message);
    throw error;
  }
}

// Экспорт функций
module.exports = {
  loadData,
  loadFromGitHub,
  parseCSVData,
  filterDailyData,
  createMonthlyData,
  saveDataToJson,
  loadFromSpecificGitHub
};

// Пример использования (если файл запускается напрямую)
if (require.main === module) {
  const args = process.argv.slice(2);
  const source = args[0] || 'https://github.com/buschevapoly-del/new_project_nndl/blob/97648cb37fafc348b073c1085c7c31df779e97dd/my_data.csv';
  const outputPath = args[1] || './historical-data.json';
  const isMonthly = args.includes('--monthly');
  
  loadData(source, { monthly: isMonthly })
    .then(data => {
      saveDataToJson(data, outputPath);
      console.log('Готово!');
    })
    .catch(error => {
      console.error('Ошибка:', error);
      process.exit(1);
    });
}
